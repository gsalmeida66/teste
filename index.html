import React, { useState, useEffect } from 'react';

// Helper function to calculate the number of business days between two dates
const getBusinessDays = (startDate, endDate) => {
  let count = 0;
  const currentDate = new Date(startDate);
  while (currentDate <= endDate) {
    const dayOfWeek = currentDate.getDay();
    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
      count++;
    }
    currentDate.setDate(currentDate.getDate() + 1);
  }
  return count;
};

// Helper function to add business days to a date
const addBusinessDays = (date, days) => {
  const result = new Date(date);
  let addedDays = 0;
  while (addedDays < days) {
    result.setDate(result.getDate() + 1);
    if (result.getDay() !== 0 && result.getDay() !== 6) {
      addedDays++;
    }
  }
  return result;
};

const formatDate = (date) => {
  if (!date) return '';
  const d = new Date(date);
  const options = { month: 'short', day: 'numeric' };
  return d.toLocaleDateString('pt-BR', options);
};

const App = () => {
  const timelineStartDateBotSac = new Date('2025-06-13T00:00:00');
  const timelineStartDateUra = new Date('2025-08-11T00:00:00');
  const daysPerPixel = 40;
  const minWidthTimeline = 3000; 

  const [projects, setProjects] = useState([
    {
      id: 'bot_sac',
      name: 'BOT SAC (Menu ACOA)',
      tasks: [
        { id: '98', name: 'Escopo', duration: 3, status: 'Concluída', predecessors: [] },
        { id: '99', name: 'UX - SD', duration: 2, status: 'Concluída', predecessors: ['98'] },
        { id: '101', name: 'UX - Spec', duration: 9, status: 'Concluída', predecessors: ['98'] },
        { id: '100', name: 'Movida - Aprovação SD', duration: 28, status: 'Concluída', predecessors: ['99'] },
        { id: '104', name: 'DEV - Desenvolvimento', duration: 7, status: 'Concluída', predecessors: ['100'] },
        { id: '102', name: 'BI - Marcação e Documentação', duration: 2, status: 'Concluída', predecessors: ['100'] },
        { id: '103', name: 'QA - Planejamento Modelagem', duration: 3, status: 'Concluída', predecessors: ['102'] },
        { id: '105', name: 'QA - Execução', duration: 3, status: 'Em Andamento', predecessors: ['103'] },
        { id: '106', name: 'PO - Certificação', duration: 3, status: 'Não Iniciado', predecessors: ['105'] },
        { id: '107', name: 'GMUD', duration: 1, status: 'Não Iniciado', predecessors: ['106'] },
      ],
    },
    {
      id: 'bot_cpa',
      name: 'Bot CPA',
      tasks: [
        { id: 'hld-cpa', name: 'HLD', duration: 2, status: 'Concluída', predecessors: [] },
        { id: 'aprovacao-hld-cpa', name: '[Movida] Aprovação HLD', duration: 4, status: 'Concluída', predecessors: ['hld-cpa'] },
        { id: 'cpa-1', name: 'Escopo', duration: 2, status: 'Não Iniciado', predecessors: ['aprovacao-hld-cpa'] },
        { id: 'cpa-2', name: 'UX - Spec', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-1'] },
        { id: 'cpa-3', name: 'UX - SD', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-1'] },
        { id: 'cpa-4', name: 'Movida - Aprovação SD', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-3'] },
        { id: 'cpa-ux-spec-new', name: 'UX - SPEC', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-4'] },
        { id: 'cpa-bi-doc-new', name: 'BI - Marcação Documentação', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-ux-spec-new'] },
        { id: 'cpa-6', name: 'DEV - Desenvolvimento de Fluxo', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-bi-doc-new'] },
        { id: 'cpa-7', name: 'QA - Planejamento Modelagem', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-bi-doc-new'] },
        { id: 'cpa-8', name: 'QA - Execução de Testes', duration: 2, status: 'Não Iniciado', predecessors: ['cpa-7'] },
        { id: 'cpa-9', name: 'PO - Certificação', duration: 1, status: 'Não Iniciado', predecessors: ['cpa-8'] },
        { id: 'cpa-10', name: 'GMUD', duration: 1, status: 'Não Iniciado', predecessors: ['cpa-9'] },
      ],
    },
    {
      id: 'ura_reservas',
      name: 'URA Reservas',
      tasks: [
        { id: 'hld-ura', name: 'HLD', duration: 2, status: 'Não Iniciado', predecessors: [], startDate: new Date('2025-07-30T00:00:00')},
        { id: 'aprovacao-hld-ura', name: '[Movida] Aprovação HLD', duration: 4, status: 'Não Iniciado', predecessors: ['hld-ura'] },
        { id: '183', name: 'Escopo', duration: 2, status: 'Não Iniciado', predecessors: ['aprovacao-hld-ura'] },
        { id: '186', name: 'UX - Spec', duration: 2, status: 'Não Iniciado', predecessors: ['183'] },
        { id: '184', name: 'UX - SD', duration: 2, status: 'Não Iniciado', predecessors: ['183'] },
        { id: '185', name: 'Movida - Aprovação SD', duration: 2, status: 'Não Iniciado', predecessors: ['184'] },
        { id: 'ura-ux-spec-new', name: 'UX - SPEC', duration: 2, status: 'Não Iniciado', predecessors: ['185'] },
        { id: 'ura-bi-doc-new', name: 'BI - Marcação Documentação', duration: 2, status: 'Não Iniciado', predecessors: ['ura-ux-spec-new'] },
        { id: '189', name: 'DEV - Desenvolvimento de Fluxo', duration: 2, status: 'Não Iniciado', predecessors: ['ura-bi-doc-new'] },
        { id: '188', name: 'QA - Planejamento Modelagem', duration: 2, status: 'Não Iniciado', predecessors: ['ura-bi-doc-new'] },
        { id: '190', name: 'QA - Execução de Testes', duration: 2, status: 'Não Iniciado', predecessors: ['188'] },
        { id: '191', name: 'PO - Certificação', duration: 1, status: 'Não Iniciado', predecessors: ['190'] },
        { id: '192', name: 'GMUD', duration: 1, status: 'Não Iniciado', predecessors: ['191'] },
      ],
    },
    {
      id: 'ura_nova_reserva',
      name: 'URA Reservas (Automação Nova Reserva)',
      tasks: [
        { id: 'hld-e2', name: 'HLD', duration: 2, status: 'Não Iniciado', predecessors: [] },
        { id: 'aprovacao-hld-e2', name: '[Movida] Aprovação HLD', duration: 4, status: 'Não Iniciado', predecessors: ['hld-e2'] },
        { id: 'e2-1', name: 'Escopo', duration: 2, status: 'Não Iniciado', predecessors: ['aprovacao-hld-e2'] },
        { id: 'e2-2', name: 'UX - Spec', duration: 2, status: 'Não Iniciado', predecessors: ['e2-1'] },
        { id: 'e2-3', name: 'UX - SD', duration: 2, status: 'Não Iniciado', predecessors: ['e2-1'] },
        { id: 'e2-4', name: 'Movida - Aprovação SD', duration: 2, status: 'Não Iniciado', predecessors: ['e2-3'] },
        { id: 'unr-ux-spec-new', name: 'UX - SPEC', duration: 2, status: 'Não Iniciado', predecessors: ['e2-4'] },
        { id: 'unr-bi-doc-new', name: 'BI - Marcação Documentação', duration: 2, status: 'Não Iniciado', predecessors: ['unr-ux-spec-new'] },
        { id: 'e2-6', name: 'DEV - Desenvolvimento de Fluxo', duration: 2, status: 'Não Iniciado', predecessors: ['unr-bi-doc-new'] },
        { id: 'e2-7', name: 'QA - Planejamento Modelagem', duration: 2, status: 'Não Iniciado', predecessors: ['unr-bi-doc-new'] },
        { id: 'e2-8', name: 'QA - Execução de Testes', duration: 2, status: 'Não Iniciado', predecessors: ['e2-7'] },
        { id: 'e2-9', name: 'PO - Certificação', duration: 1, status: 'Não Iniciado', predecessors: ['e2-8'] },
        { id: 'e2-10', name: 'GMUD', duration: 1, status: 'Não Iniciado', predecessors: ['e2-9'] },
      ],
    },
  ]);

  const [editingTask, setEditingTask] = useState(null);
  const [formState, setFormState] = useState({ name: '', duration: 0, status: 'Não Iniciado' });
  const [editingProjectId, setEditingProjectId] = useState(null);
  const [taskPositions, setTaskPositions] = useState({});

  useEffect(() => {
    const allTasks = projects.flatMap(p => p.tasks.map(t => ({ ...t, projectId: p.id })));
    const positions = {};

    allTasks.forEach(task => {
      let startDate;
      
      if (task.predecessors && task.predecessors.length > 0) {
        const predecessorEndDates = task.predecessors.map(predId => {
          const predPos = positions[predId];
          return predPos ? addBusinessDays(predPos.startDate, predPos.duration - 1) : timelineStartDateBotSac;
        });
        startDate = addBusinessDays(new Date(Math.max(...predecessorEndDates)), 1);
      } else {
        startDate = task.projectId === 'ura_reservas' ? new Date('2025-07-30T00:00:00') : (task.projectId === 'bot_cpa' ? new Date('2025-07-23T00:00:00') : (task.projectId === 'ura_nova_reserva' ? addBusinessDays(positions['cpa-4'].startDate, positions['cpa-4'].duration) : timelineStartDateBotSac));
      }
      
      const referenceDate = timelineStartDateBotSac;
      const businessDaysFromStart = getBusinessDays(referenceDate, startDate);
      const left = (businessDaysFromStart - 1) * daysPerPixel;
      const width = task.duration * daysPerPixel;
      
      positions[task.id] = { startDate, duration: task.duration, left, width };
    });
    
    setTaskPositions(positions);
  }, [projects]);

  const getTaskColor = (status) => {
    switch (status) {
      case 'Concluída':
        return 'bg-green-500';
      case 'Em Andamento':
        return 'bg-blue-500';
      default:
        return 'bg-gray-400';
    }
  };

  const handleEditTask = (projectId, taskId) => {
    const project = projects.find(p => p.id === projectId);
    const task = project.tasks.find(t => t.id === taskId);
    setEditingTask(task);
    setEditingProjectId(projectId);
    setFormState({
      name: task.name,
      duration: task.duration,
      status: task.status,
    });
  };

  const handleSaveEdit = (e) => {
    e.preventDefault();
    setProjects(prevProjects =>
      prevProjects.map(project =>
        project.id === editingProjectId
          ? {
              ...project,
              tasks: project.tasks.map(task =>
                task.id === editingTask.id
                  ? { ...task, ...formState, duration: Number(formState.duration) }
                  : task
              ),
            }
          : project
      )
    );
    setEditingTask(null);
    setEditingProjectId(null);
  };

  const getTimelineDates = () => {
    const dates = [];
    const botSacLastTask = projects.find(p => p.id === 'bot_sac').tasks.find(t => t.id === '107');
    const uraLastTask = projects.find(p => p.id === 'ura_reservas').tasks.find(t => t.id === '192');
    const botCpaLastTask = projects.find(p => p.id === 'bot_cpa').tasks.find(t => t.id === 'cpa-10');
    const exemplo2LastTask = projects.find(p => p.id === 'ura_nova_reserva').tasks.find(t => t.id === 'e2-10');
    
    const botSacEndDate = taskPositions[botSacLastTask.id] ? addBusinessDays(taskPositions[botSacLastTask.id].startDate, taskPositions[botSacLastTask.id].duration) : timelineStartDateBotSac;
    const uraEndDate = taskPositions[uraLastTask.id] ? addBusinessDays(taskPositions[uraLastTask.id].startDate, taskPositions[uraLastTask.id].duration) : timelineStartDateUra;
    const botCpaEndDate = taskPositions[botCpaLastTask.id] ? addBusinessDays(taskPositions[botCpaLastTask.id].startDate, taskPositions[botCpaLastTask.id].duration) : timelineStartDateUra;
    const exemplo2EndDate = taskPositions[exemplo2LastTask.id] ? addBusinessDays(taskPositions[exemplo2LastTask.id].startDate, taskPositions[exemplo2LastTask.id].duration) : timelineStartDateUra;
    

    const endDate = new Date(Math.max(botSacEndDate.getTime(), uraEndDate.getTime(), botCpaEndDate.getTime(), exemplo2EndDate.getTime()));
    
    let currentDate = new Date(timelineStartDateBotSac);
    
    const markers = [];
    while(currentDate < endDate) {
      if (currentDate.getDay() === 1) {
        markers.push(new Date(currentDate));
      }
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return markers;
  };

  return (
    <div className="bg-gray-50 flex items-center justify-center p-8 min-h-screen">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-5xl">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Plano de Ação de Retenção</h1>
        
        <div className="flex justify-end space-x-4 mb-4">
          <div className="flex items-center">
            <div className="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
            <span className="text-sm text-gray-600">Concluída</span>
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 rounded-full bg-blue-500 mr-2"></div>
            <span className="text-sm text-gray-600">Em Andamento</span>
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 rounded-full bg-gray-400 mr-2"></div>
            <span className="text-sm text-gray-600">Não Iniciado</span>
          </div>
        </div>

        <div className="relative w-full overflow-x-auto pb-6">
          <div className="flex items-center text-xs text-gray-500 mb-4 ml-[64px] relative">
            <div className="relative" style={{ width: '100%', minWidth: `${minWidthTimeline}px` }}>
              <div className="absolute inset-y-0 left-0 right-0 h-1 bg-gray-200 z-0 top-1/2 -translate-y-1/2"></div>
              <div className="flex justify-between relative z-10">
                {getTimelineDates().map((date, index) => (
                  <div key={index} className="text-center absolute" style={{ left: `${(getBusinessDays(timelineStartDateBotSac, date) - 1) * daysPerPixel}px` }}>
                    <div className="relative">
                      {formatDate(date)}
                      <div className="absolute bottom-[-1.5rem] left-1/2 -translate-x-1/2 h-10 w-px bg-gray-300"></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {projects.map(project => (
            <div key={project.id} className="flex items-center mb-6">
              <div className="w-16 flex-shrink-0 text-sm font-semibold text-gray-700">{project.name}</div>
              <div className="flex-grow relative h-16" style={{ minWidth: `${minWidthTimeline}px` }}>
                {project.tasks.map(task => {
                  const { left, width, startDate } = taskPositions[task.id] || {};
                  if (!left) return null;
                  return (
                    <div
                      key={task.id}
                      className={`absolute top-1/2 -translate-y-1/2 ${getTaskColor(task.status)} h-14 rounded-md flex items-center text-sm text-white font-semibold shadow cursor-pointer transition-all duration-300 hover:scale-105`}
                      style={{ left: `${left}px`, width: `${width}px` }}
                      onClick={() => handleEditTask(project.id, task.id)}
                      title={`${task.name} (${formatDate(startDate)} a ${formatDate(addBusinessDays(startDate, task.duration))})`}
                    >
                      <span className="pl-2">{task.name}</span>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>

        {editingTask && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
              <h2 className="text-lg font-bold mb-4">Editar Tarefa: {editingTask.name}</h2>
              <form onSubmit={handleSaveEdit}>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700">Nome da Tarefa</label>
                  <input
                    type="text"
                    value={formState.name}
                    onChange={(e) => setFormState({ ...formState, name: e.target.value })}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                  />
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700">Duração (dias úteis)</label>
                  <input
                    type="number"
                    value={formState.duration}
                    onChange={(e) => setFormState({ ...formState, duration: e.target.value })}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    min="1"
                  />
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700">Status</label>
                  <select
                    value={formState.status}
                    onChange={(e) => setFormState({ ...formState, status: e.target.value })}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                  >
                    <option>Concluída</option>
                    <option>Em Andamento</option>
                    <option>Não Iniciado</option>
                  </select>
                </div>
                <div className="flex justify-end space-x-2">
                  <button
                    type="button"
                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                    onClick={() => setEditingTask(null)}
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
                  >
                    Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
